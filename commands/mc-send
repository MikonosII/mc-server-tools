#!/usr/bin/env bash
# mc-send â€” send a command to the "mc" screen session inside a CT
set -euo pipefail

usage() {
  cat <<'EOF'
Usage: mc send <CTID> <command...>

Examples:
  mc send 25565 "list"
  mc send 25565 "save-all"
EOF
}

ctid="${1:-}"; shift || true
[[ -n "$ctid" && $# -gt 0 ]] || { usage >&2; exit 2; }
cmd="$*"

# ensure CT exists
pct config "$ctid" >/dev/null 2>&1 || { echo "[mc-send] CTID $ctid not found" >&2; exit 1; }

# ensure 'mc' session exists
if ! pct exec "$ctid" -- bash -lc 'screen -ls 2>/dev/null | grep -q "\.mc"'; then
  echo "[mc-send] No 'mc' screen session found in CT $ctid" >&2
  exit 1
fi

# send the command + CR safely
printf '%s\r' "$cmd" | pct exec "$ctid" -- bash -lc '
  IFS= read -r line
  screen -S mc -X stuff "$line"
'
